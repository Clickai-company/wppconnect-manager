<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WppConnect Manager - EduCRM Pro</title>
    <meta name="description" content="Interface de gerenciamento para inst√¢ncias WhatsApp do EduCRM Pro">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì±</text></svg>">
    
    <style>
        /* ===== VARI√ÅVEIS CSS - CORES CLICKAI ===== */
        :root {
            --primary: #1e3a5f; --primary-dark: #152b47; --primary-light: #2a4d73;
            --secondary: #c8a96e; --secondary-dark: #b8995e; --secondary-light: #d4b97e;
            --success: #28a745; --success-dark: #1e7e34; --warning: #ffc107; --warning-dark: #e0a800;
            --danger: #dc3545; --danger-dark: #c82333; --info: #17a2b8; --info-dark: #117a8b;
            --gray-50: #f8f9fa; --gray-100: #e9ecef; --gray-200: #dee2e6; --gray-600: #6c757d;
            --gray-800: #343a40; --white: #ffffff; --shadow: 0 20px 40px rgba(30, 58, 95, 0.15);
            --radius: 12px; --radius-lg: 16px; --spacing-sm: 8px; --spacing-md: 16px;
            --spacing-lg: 24px; --spacing-xl: 32px;
        }
        
        /* ===== RESET E BASE ===== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1e3a5f 0%, #2a4d73 50%, #c8a96e 100%);
            min-height: 100vh; color: var(--gray-800); line-height: 1.6;
        }
        
        /* ===== CONTAINER ===== */
        .container { max-width: 1400px; margin: 0 auto; padding: var(--spacing-lg); }
        
        /* ===== HEADER ===== */
        .header { text-align: center; margin-bottom: var(--spacing-xl); color: var(--white); }
        .header h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: var(--spacing-sm); text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.1rem; opacity: 0.95; }
        .header .domain { font-size: 0.9rem; background: rgba(200, 169, 110, 0.2); padding: var(--spacing-sm) var(--spacing-md);
                         border-radius: var(--radius); margin-top: var(--spacing-sm); backdrop-filter: blur(10px); display: inline-block;
                         border: 1px solid rgba(200, 169, 110, 0.3); }
        
        /* ===== STATS BAR ===== */
        .stats-bar { display: flex; justify-content: space-between; align-items: center; 
                    background: linear-gradient(135deg, rgba(200, 169, 110, 0.15) 0%, rgba(30, 58, 95, 0.15) 100%);
                    padding: var(--spacing-md); border-radius: var(--radius); margin-bottom: var(--spacing-lg);
                    color: var(--white); backdrop-filter: blur(15px); flex-wrap: wrap; gap: var(--spacing-md);
                    border: 1px solid rgba(255, 255, 255, 0.1); }
        
        /* ===== DASHBOARD ===== */
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
                    gap: var(--spacing-xl); margin-bottom: var(--spacing-xl); }
        
        /* ===== CARDS ===== */
        .card { background: var(--white); border-radius: var(--radius-lg); padding: var(--spacing-xl);
               box-shadow: var(--shadow); backdrop-filter: blur(10px); 
               border: 1px solid rgba(200, 169, 110, 0.1);
               transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card:hover { transform: translateY(-4px); 
                     box-shadow: 0 25px 50px rgba(30, 58, 95, 0.2), 0 0 20px rgba(200, 169, 110, 0.1); }
        .card h2 { color: var(--primary); margin-bottom: var(--spacing-lg); display: flex; align-items: center;
                  gap: var(--spacing-sm); font-size: 1.3rem; font-weight: 600; }
        
        /* ===== STATUS GRID ===== */
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                      gap: var(--spacing-md); margin-bottom: var(--spacing-lg); }
        .status-item { background: var(--gray-50); padding: var(--spacing-md); border-radius: var(--radius);
                      text-align: center; border: 2px solid transparent; transition: all 0.3s ease; }
        .status-item.connected { border-color: var(--success); 
                               background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); }
        .status-item.disconnected { border-color: var(--danger); 
                                   background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); }
        .status-value { font-size: 1.8rem; font-weight: 700; margin-bottom: var(--spacing-sm); color: var(--primary); }
        .status-label { font-size: 0.85rem; color: var(--gray-600); font-weight: 500; }
        
        /* ===== FORMUL√ÅRIOS ===== */
        .form-group { margin-bottom: var(--spacing-lg); }
        .form-group label { display: block; margin-bottom: var(--spacing-sm); font-weight: 600; color: var(--primary); }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: var(--spacing-md); border: 2px solid var(--gray-200);
            border-radius: var(--radius); font-size: 1rem; transition: all 0.3s ease; background: var(--white); }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: var(--secondary); 
            box-shadow: 0 0 0 3px rgba(200, 169, 110, 0.15); }
        
        /* ===== BOT√ïES ===== */
        .btn { padding: var(--spacing-md) var(--spacing-lg); border: none; border-radius: var(--radius);
              font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
              margin-right: var(--spacing-sm); margin-bottom: var(--spacing-sm);
              display: inline-flex; align-items: center; gap: var(--spacing-sm);
              text-decoration: none; min-height: 44px; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background: var(--primary); color: var(--white); 
                      box-shadow: 0 4px 12px rgba(30, 58, 95, 0.3); }
        .btn-primary:hover:not(:disabled) { background: var(--primary-dark); transform: translateY(-2px);
                                          box-shadow: 0 6px 16px rgba(30, 58, 95, 0.4); }
        .btn-success { background: var(--success); color: var(--white); 
                      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); }
        .btn-success:hover:not(:disabled) { background: var(--success-dark); transform: translateY(-2px);
                                          box-shadow: 0 6px 16px rgba(40, 167, 69, 0.4); }
        .btn-danger { background: var(--danger); color: var(--white); 
                     box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3); }
        .btn-danger:hover:not(:disabled) { background: var(--danger-dark); transform: translateY(-2px);
                                         box-shadow: 0 6px 16px rgba(220, 53, 69, 0.4); }
        .btn-warning { background: var(--secondary); color: var(--primary); 
                      box-shadow: 0 4px 12px rgba(200, 169, 110, 0.3); font-weight: 700; }
        .btn-warning:hover:not(:disabled) { background: var(--secondary-dark); transform: translateY(-2px);
                                          box-shadow: 0 6px 16px rgba(200, 169, 110, 0.4); }
        
        /* ===== INST√ÇNCIAS ===== */
        .instances-list { margin-top: var(--spacing-lg); }
        .instance-item { background: var(--gray-50); padding: var(--spacing-lg); border-radius: var(--radius);
                        margin-bottom: var(--spacing-md); border-left: 4px solid var(--secondary); 
                        transition: all 0.3s ease; }
        .instance-item:hover { background: var(--white); 
                              box-shadow: 0 4px 12px rgba(30, 58, 95, 0.1), 0 0 8px rgba(200, 169, 110, 0.1); }
        .instance-header { display: flex; justify-content: space-between; align-items: center;
                          margin-bottom: var(--spacing-md); flex-wrap: wrap; gap: var(--spacing-sm); }
        .instance-name { font-weight: 700; font-size: 1.1rem; color: var(--primary); }
        .instance-status { padding: 4px var(--spacing-md); border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
        .status-connected { background: var(--success); color: var(--white); }
        .status-disconnected { background: var(--danger); color: var(--white); }
        .instance-actions { display: flex; gap: var(--spacing-sm); flex-wrap: wrap; }
        
        /* ===== QR CODE ===== */
        .qr-container { text-align: center; padding: var(--spacing-xl); background: var(--gray-50);
                       border-radius: var(--radius); margin-top: var(--spacing-lg); 
                       border: 2px dashed var(--secondary); }
        .qr-code { max-width: 256px; width: 100%; height: auto; border: 2px solid var(--secondary);
                  border-radius: var(--radius); background: var(--white); }
        
        /* ===== LOGS ===== */
        .logs { background: var(--primary); color: #e2e8f0; padding: var(--spacing-lg); border-radius: var(--radius);
               font-family: 'SFMono-Regular', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
               font-size: 0.9rem; max-height: 400px; overflow-y: auto; margin-top: var(--spacing-lg); 
               line-height: 1.4; border: 1px solid var(--secondary); }
        .logs::-webkit-scrollbar { width: 8px; }
        .logs::-webkit-scrollbar-track { background: var(--primary-dark); }
        .logs::-webkit-scrollbar-thumb { background: var(--secondary); border-radius: 4px; }
        
        /* ===== ALERTAS ===== */
        .alert { padding: var(--spacing-md) var(--spacing-lg); border-radius: var(--radius);
                margin-bottom: var(--spacing-lg); border: 1px solid; display: flex;
                align-items: center; gap: var(--spacing-sm); }
        .alert-success { background: #d4edda; color: #155724; border-color: var(--success); }
        .alert-error { background: #f8d7da; color: #721c24; border-color: var(--danger); }
        .alert-info { background: #d1ecf1; color: #0c5460; border-color: var(--info); }
        
        /* ===== LOADING ===== */
        .loading { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--secondary);
                  border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* ===== EMPTY STATE ===== */
        .empty-state { text-align: center; padding: var(--spacing-xl); color: var(--gray-600); }
        .empty-state h3 { font-size: 1.2rem; margin-bottom: var(--spacing-sm); color: var(--primary); }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .container { padding: var(--spacing-md); }
            .dashboard { grid-template-columns: 1fr; }
            .instance-header { flex-direction: column; align-items: flex-start; }
            .instance-actions { justify-content: flex-start; width: 100%; }
            .header h1 { font-size: 2rem; }
            .stats-bar { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± WppConnect Manager</h1>
            <p>Interface de Gerenciamento WhatsApp - EduCRM Pro</p>
            <div class="domain">üåê wpp-manager.clickai.company</div>
        </div>

        <div class="stats-bar">
            <div>
                <strong>üöÄ Sistema:</strong> <span id="system-status">Verificando...</span>
            </div>
            <div>
                <strong>üîÑ √öltima atualiza√ß√£o:</strong> <span id="last-update">--</span>
            </div>
        </div>

        <div id="alerts"></div>

        <div class="dashboard">
            <!-- Status Geral -->
            <div class="card">
                <h2>üìä Status do Sistema</h2>
                <div class="status-grid">
                    <div class="status-item" id="api-status">
                        <div class="status-value">--</div>
                        <div class="status-label">API Status</div>
                    </div>
                    <div class="status-item" id="total-sessions">
                        <div class="status-value">--</div>
                        <div class="status-label">Total Sess√µes</div>
                    </div>
                    <div class="status-item" id="connected-sessions">
                        <div class="status-value">--</div>
                        <div class="status-label">Conectadas</div>
                    </div>
                    <div class="status-item" id="uptime">
                        <div class="status-value">--</div>
                        <div class="status-label">Uptime</div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="refreshStatus()">
                    <span id="refresh-icon">üîÑ</span> Atualizar Status
                </button>
                <button class="btn btn-success" onclick="startAutoRefresh()">
                    ‚è±Ô∏è Auto-refresh
                </button>
            </div>

            <!-- Criar Nova Inst√¢ncia -->
            <div class="card">
                <h2>‚ûï Nova Inst√¢ncia WhatsApp</h2>
                <div class="form-group">
                    <label for="instance-name">Nome da Inst√¢ncia:</label>
                    <input type="text" id="instance-name" placeholder="ex: educrm-vendas-2024" maxlength="50" />
                </div>
                <div class="form-group">
                    <label for="webhook-url">URL do Webhook:</label>
                    <input type="url" id="webhook-url" value="https://webhook.clickai.company/webhook/whatsapp" />
                </div>
                <button class="btn btn-success" onclick="createInstance()" id="create-btn">
                    ‚ú® Criar Inst√¢ncia
                </button>
                
                <div id="qr-container" class="qr-container" style="display: none;">
                    <h3>üì± QR Code para Conex√£o</h3>
                    <p>Abra WhatsApp Business e escaneie:</p>
                    <img id="qr-image" class="qr-code" alt="QR Code" />
                    <p><small>‚è±Ô∏è QR Code expira em 2 minutos</small></p>
                    <button class="btn btn-warning" onclick="refreshQR()">üîÑ Gerar Novo QR</button>
                </div>
            </div>

            <!-- Gerenciar Inst√¢ncias -->
            <div class="card">
                <h2>‚öôÔ∏è Inst√¢ncias Ativas</h2>
                <div style="margin-bottom: var(--spacing-lg);">
                    <button class="btn btn-primary" onclick="loadInstances()">
                        üìã Recarregar Lista
                    </button>
                    <button class="btn btn-warning" onclick="checkAllConnections()">
                        üîç Verificar Conex√µes
                    </button>
                </div>
                <div id="instances-list" class="instances-list">
                    <div class="empty-state">
                        <h3>üì± Nenhuma inst√¢ncia carregada</h3>
                        <p>Clique em "Recarregar Lista" para ver suas inst√¢ncias</p>
                    </div>
                </div>
            </div>

            <!-- Teste R√°pido -->
            <div class="card">
                <h2>üß™ Teste R√°pido de Envio</h2>
                <div class="form-group">
                    <label for="test-session">Selecionar Sess√£o:</label>
                    <select id="test-session">
                        <option value="">Escolha uma sess√£o...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="test-number">N√∫mero (formato: 5541999999999):</label>
                    <input type="tel" id="test-number" placeholder="5541999999999" pattern="[0-9]{13}" />
                </div>
                <div class="form-group">
                    <label for="test-message">Mensagem de Teste:</label>
                    <textarea id="test-message" rows="3" placeholder="Digite sua mensagem de teste...">üß™ Teste do WppConnect Manager - EduCRM Pro
Sistema funcionando perfeitamente!
Enviado via: wpp-manager.clickai.company</textarea>
                </div>
                <button class="btn btn-warning" onclick="sendTestMessage()" id="test-btn">
                    üì§ Enviar Teste
                </button>
                <button class="btn btn-primary" onclick="validateNumber()" id="validate-btn">
                    ‚úÖ Validar N√∫mero
                </button>
            </div>
        </div>

        <!-- Logs Avan√ßados -->
        <div class="card">
            <h2>üìã Console de Atividades</h2>
            <div style="margin-bottom: var(--spacing-lg);">
                <button class="btn btn-primary" onclick="clearLogs()">
                    üóëÔ∏è Limpar Console
                </button>
                <button class="btn btn-success" onclick="exportLogs()">
                    üì• Exportar Logs
                </button>
                <button class="btn btn-warning" onclick="toggleVerbose()">
                    üîç <span id="verbose-toggle">Verbose Off</span>
                </button>
            </div>
            <div id="logs" class="logs">
üöÄ WppConnect Manager iniciado
üì° Conectando com API base...
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURA√á√ÉO DA API =====
        const API_BASE = 'http://31.97.87.194:21465';
        const SECRET_KEY = 'EDUCRM_SECURE_TOKEN_2024';

        // ===== VARI√ÅVEIS GLOBAIS =====
        let instances = [];
        let autoRefreshInterval = null;
        let verboseMode = false;
        let startTime = Date.now();

        // ===== FUN√á√ïES DE LOG E ALERTA =====
        function addLog(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString('pt-BR');
            const icons = {
                'info': '‚ÑπÔ∏è', 'success': '‚úÖ', 'error': '‚ùå', 'warning': '‚ö†Ô∏è', 'debug': 'üîç'
            };
            const icon = icons[type] || '‚ÑπÔ∏è';
            logs.textContent += `[${timestamp}] ${icon} ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
        }

        function showAlert(message, type = 'success') {
            const alerts = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            const icons = { 'success': '‚úÖ', 'error': '‚ùå', 'info': '‚ÑπÔ∏è' };
            alert.innerHTML = `${icons[type]} ${message}`;
            alerts.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        // ===== CHAMADAS API CORRIGIDAS =====
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || data.message || `HTTP ${response.status}`);
                }
                
                return { success: true, data };
            } catch (error) {
                addLog(`‚ùå API Error [${endpoint}]: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        // ===== FUN√á√ÉO PRINCIPAL DE REFRESH =====
        async function refreshStatus() {
            const refreshIcon = document.getElementById('refresh-icon');
            refreshIcon.innerHTML = '<div class="loading"></div>';
            
            try {
                addLog('üîÑ Verificando status da API...', 'info');
                
                // Testar endpoint principal
                const healthResult = await apiCall('/');
                
                if (healthResult.success) {
                    const apiData = healthResult.data;
                    
                    document.getElementById('api-status').innerHTML = '<div class="status-value">‚úÖ</div><div class="status-label">Online</div>';
                    document.getElementById('api-status').className = 'status-item connected';
                    document.getElementById('system-status').textContent = '‚úÖ Operacional';
                    
                    // Buscar sess√µes ativas
                    const sessionsResult = await apiCall(`/api/${SECRET_KEY}/show-all-sessions`);
                    
                    if (sessionsResult.success) {
                        const sessionsData = sessionsResult.data;
                        const totalSessions = sessionsData.count || 0;
                        const connectedSessions = sessionsData.sessions ? 
                            sessionsData.sessions.filter(s => s.state === 'CONNECTED').length : 0;
                        
                        document.getElementById('total-sessions').innerHTML = 
                            `<div class="status-value">${totalSessions}</div><div class="status-label">Total</div>`;
                        document.getElementById('connected-sessions').innerHTML = 
                            `<div class="status-value">${connectedSessions}</div><div class="status-label">Conectadas</div>`;
                        
                        // Atualizar select de teste
                        const testSelect = document.getElementById('test-session');
                        testSelect.innerHTML = '<option value="">Escolha uma sess√£o...</option>';
                        if (sessionsData.sessions) {
                            sessionsData.sessions.forEach(session => {
                                testSelect.innerHTML += `<option value="${session.session}">${session.session}</option>`;
                            });
                        }
                        
                        addLog(`‚úÖ Status atualizado: ${totalSessions} sess√£o(es), ${connectedSessions} conectada(s)`, 'success');
                    }
                    
                    document.getElementById('uptime').innerHTML = `<div class="status-value">${getUptime()}</div><div class="status-label">Uptime</div>`;
                    document.getElementById('last-update').textContent = new Date().toLocaleTimeString('pt-BR');
                    
                } else {
                    throw new Error(healthResult.error);
                }
                
            } catch (error) {
                addLog(`‚ùå Erro: ${error.message}`, 'error');
                showAlert('Erro ao conectar com a API', 'error');
                document.getElementById('api-status').innerHTML = '<div class="status-value">‚ùå</div><div class="status-label">Offline</div>';
                document.getElementById('api-status').className = 'status-item disconnected';
                document.getElementById('system-status').textContent = '‚ùå Erro de conex√£o';
            }
            
            refreshIcon.innerHTML = 'üîÑ';
        }

        function getUptime() {
            const uptime = Date.now() - startTime;
            const minutes = Math.floor(uptime / 60000);
            const hours = Math.floor(minutes / 60);
            if (hours > 0) return `${hours}h ${minutes % 60}m`;
            return `${minutes}m`;
        }

        // ===== CRIAR NOVA INST√ÇNCIA =====
        async function createInstance() {
            const instanceName = document.getElementById('instance-name').value.trim();
            const webhookUrl = document.getElementById('webhook-url').value.trim();
            const createBtn = document.getElementById('create-btn');
            
            if (!instanceName) {
                showAlert('Nome da inst√¢ncia √© obrigat√≥rio!', 'error');
                return;
            }
            
            createBtn.disabled = true;
            createBtn.innerHTML = '<div class="loading"></div> Criando...';
            
            try {
                addLog(`üî® Criando sess√£o: ${instanceName}...`, 'info');
                
                // Usar endpoint da nova API
                const result = await apiCall(`/api/${instanceName}/start-session`, {
                    method: 'POST',
                    body: JSON.stringify({ webhook: webhookUrl })
                });
                
                if (result.success) {
                    addLog(`‚úÖ Sess√£o criada: ${instanceName}`, 'success');
                    showAlert(`Sess√£o "${instanceName}" criada!`, 'success');
                    
                    document.getElementById('instance-name').value = '';
                    
                    // Aguardar um pouco e verificar se gerou QR Code
                    setTimeout(async () => {
                        const qrResult = await apiCall(`/api/${instanceName}/qrcode-session`);
                        if (qrResult.success && qrResult.data.qrcode) {
                            document.getElementById('qr-image').src = qrResult.data.qrcode;
                            document.getElementById('qr-container').style.display = 'block';
                            addLog('üì± QR Code gerado', 'success');
                        }
                        refreshStatus();
                        loadInstances();
                    }, 3000);
                    
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                addLog(`‚ùå Erro: ${error.message}`, 'error');
                showAlert('Erro ao criar inst√¢ncia', 'error');
            } finally {
                createBtn.disabled = false;
                createBtn.innerHTML = '‚ú® Criar Inst√¢ncia';
            }
        }

        // ===== CARREGAR INST√ÇNCIAS =====
        async function loadInstances() {
            try {
                addLog('üìã Carregando inst√¢ncias...', 'info');
                
                const result = await apiCall(`/api/${SECRET_KEY}/show-all-sessions`);
                const instancesList = document.getElementById('instances-list');
                instancesList.innerHTML = '';
                
                if (result.success && result.data.sessions && result.data.sessions.length > 0) {
                    result.data.sessions.forEach(session => {
                        const statusClass = session.state === 'CONNECTED' ? 'status-connected' : 'status-disconnected';
                        const statusText = session.state === 'CONNECTED' ? '‚úÖ Conectada' : 
                                         session.state === 'QRCODE' ? 'üì± QR Code' : 
                                         session.state === 'INITIALIZING' ? 'üîÑ Inicializando' : '‚ùå Desconectada';
                        
                        const instanceDiv = document.createElement('div');
                        instanceDiv.className = 'instance-item';
                        instanceDiv.innerHTML = `
                            <div class="instance-header">
                                <span class="instance-name">üì± ${session.session}</span>
                                <span class="instance-status ${statusClass}">${statusText}</span>
                            </div>
                            <div class="instance-actions">
                                <button class="btn btn-primary" onclick="checkSessionStatus('${session.session}')">üîç Status</button>
                                ${session.state === 'QRCODE' ? `<button class="btn btn-warning" onclick="generateQR('${session.session}')">üì± QR Code</button>` : ''}
                                <button class="btn btn-danger" onclick="deleteInstance('${session.session}')">üóëÔ∏è Deletar</button>
                            </div>
                        `;
                        instancesList.appendChild(instanceDiv);
                    });
                    addLog(`‚úÖ ${result.data.sessions.length} inst√¢ncia(s) carregadas`, 'success');
                } else {
                    instancesList.innerHTML = '<div class="empty-state"><h3>üì± Nenhuma inst√¢ncia encontrada</h3><p>Crie uma nova inst√¢ncia para come√ßar</p></div>';
                    addLog('‚ÑπÔ∏è Nenhuma inst√¢ncia encontrada', 'info');
                }
            } catch (error) {
                addLog(`‚ùå Erro ao carregar inst√¢ncias: ${error.message}`, 'error');
                document.getElementById('instances-list').innerHTML = '<div class="empty-state"><h3>‚ùå Erro ao carregar</h3><p>Verifique a conex√£o com a API</p></div>';
            }
        }

        // ===== VERIFICAR STATUS DA SESS√ÉO =====
        async function checkSessionStatus(sessionName) {
            try {
                addLog(`üîç Verificando status: ${sessionName}`, 'info');
                
                const result = await apiCall(`/api/${sessionName}/status-session`);
                
                if (result.success) {
                    const status = result.data.state;
                    addLog(`‚úÖ Status ${sessionName}: ${status}`, 'success');
                    showAlert(`Sess√£o ${sessionName}: ${status}`, 'success');
                    
                    // Recarregar lista para atualizar status
                    setTimeout(() => loadInstances(), 1000);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                addLog(`‚ùå Erro ao verificar status: ${error.message}`, 'error');
                showAlert('Erro ao verificar status', 'error');
            }
        }

        // ===== GERAR QR CODE =====
        async function generateQR(sessionName) {
            try {
                addLog(`üì± Gerando QR Code: ${sessionName}`, 'info');
                
                const result = await apiCall(`/api/${sessionName}/qrcode-session`);
                
                if (result.success && result.data.qrcode) {
                    document.getElementById('qr-image').src = result.data.qrcode;
                    document.getElementById('qr-container').style.display = 'block';
                    addLog(`‚úÖ QR Code gerado: ${sessionName}`, 'success');
                    showAlert('QR Code gerado com sucesso!', 'success');
                } else {
                    throw new Error(result.error || 'QR Code n√£o dispon√≠vel');
                }
            } catch (error) {
                addLog(`‚ùå Erro ao gerar QR: ${error.message}`, 'error');
                showAlert('Erro ao gerar QR Code', 'error');
            }
        }

        // ===== DELETAR INST√ÇNCIA (Simula√ß√£o) =====
        async function deleteInstance(sessionName) {
            if (!confirm(`Tem certeza que deseja deletar a sess√£o "${sessionName}"?`)) return;
            
            try {
                addLog(`üóëÔ∏è Tentando deletar: ${sessionName}`, 'warning');
                
                // Como a API atual n√£o tem endpoint de delete, apenas simular
                showAlert(`Funcionalidade de deletar n√£o implementada na API atual`, 'info');
                addLog(`‚ÑπÔ∏è Endpoint de delete n√£o dispon√≠vel na API`, 'info');
                
            } catch (error) {
                addLog(`‚ùå Erro ao deletar: ${error.message}`, 'error');
                showAlert('Erro ao deletar inst√¢ncia', 'error');
            }
        }

        // ===== ENVIAR TESTE =====
        async function sendTestMessage() {
            const session = document.getElementById('test-session').value;
            const number = document.getElementById('test-number').value.trim();
            const message = document.getElementById('test-message').value.trim();
            const testBtn = document.getElementById('test-btn');
            
            if (!session || !number || !message) {
                showAlert('Preencha todos os campos!', 'error');
                return;
            }
            
            if (number.length !== 13) {
                showAlert('N√∫mero deve ter 13 d√≠gitos (ex: 5541999999999)', 'error');
                return;
            }
            
            testBtn.disabled = true;
            testBtn.innerHTML = '<div class="loading"></div> Enviando...';
            
            try {
                addLog(`üì§ Enviando teste: ${session} ‚Üí ${number}`, 'info');
                
                // Nota: A API atual n√£o tem endpoint de envio implementado
                // Simular envio por enquanto
                showAlert('Funcionalidade de envio ser√° implementada em breve', 'info');
                addLog(`‚ÑπÔ∏è Endpoint de envio n√£o implementado na API atual`, 'info');
                
                // setTimeout(() => {
                //     addLog(`‚úÖ Mensagem enviada com sucesso!`, 'success');
                //     showAlert('Mensagem enviada!', 'success');
                // }, 2000);
                
            } catch (error) {
                addLog(`‚ùå Erro no envio: ${error.message}`, 'error');
                showAlert('Erro no envio da mensagem', 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.innerHTML = 'üì§ Enviar Teste';
            }
        }

        // ===== FUN√á√ïES EXTRAS =====
        function clearLogs() {
            document.getElementById('logs').textContent = '';
            addLog('üßπ Console limpo', 'info');
        }

        function validateNumber() {
            const number = document.getElementById('test-number').value.trim();
            if (number.length === 13 && /^\d+$/.test(number)) {
                showAlert('‚úÖ N√∫mero v√°lido!', 'success');
                addLog(`‚úÖ N√∫mero validado: ${number}`, 'success');
            } else {
                showAlert('‚ùå Use exatamente 13 d√≠gitos: 5541999999999', 'error');
                addLog(`‚ùå N√∫mero inv√°lido: ${number}`, 'error');
            }
        }

        function exportLogs() {
            const logs = document.getElementById('logs').textContent;
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `wppconnect-logs-${timestamp}.txt`;
            
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            addLog(`üì• Logs exportados: ${filename}`, 'success');
            showAlert('Logs exportados com sucesso!', 'success');
        }

        function toggleVerbose() {
            verboseMode = !verboseMode;
            document.getElementById('verbose-toggle').textContent = verboseMode ? 'Verbose On' : 'Verbose Off';
            addLog(`üîç Modo verbose ${verboseMode ? 'ativado' : 'desativado'}`, 'info');
            showAlert(`Modo verbose ${verboseMode ? 'ativado' : 'desativado'}`, 'info');
        }

        function refreshQR() {
            const sessionSelect = document.getElementById('test-session');
            const selectedSession = sessionSelect.value;
            
            if (selectedSession) {
                generateQR(selectedSession);
            } else {
                showAlert('Selecione uma sess√£o primeiro', 'error');
            }
        }

        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                showAlert('Auto-refresh desativado', 'info');
                addLog('‚èπÔ∏è Auto-refresh parado', 'info');
                return;
            }
            
            autoRefreshInterval = setInterval(() => {
                refreshStatus();
                if (verboseMode) {
                    addLog('üîÑ Auto-refresh executado', 'debug');
                }
            }, 30000);
            
            showAlert('Auto-refresh ativado (30s)', 'success');
            addLog('‚è±Ô∏è Auto-refresh iniciado (intervalo: 30s)', 'info');
        }

        function checkAllConnections() {
            addLog('üîç Verificando todas as conex√µes...', 'info');
            refreshStatus();
            loadInstances();
            showAlert('Verifica√ß√£o de conex√µes iniciada', 'info');
        }

        // ===== INICIALIZA√á√ÉO =====
        document.addEventListener('DOMContentLoaded', function() {
            addLog('üöÄ WppConnect Manager iniciado', 'success');
            addLog(`üîó API Base: ${API_BASE}`, 'info');
            addLog(`üîë Secret Key: ${SECRET_KEY}`, 'info');
            
            // Inicializar status
            refreshStatus();
            showAlert('üéâ Interface carregada com sucesso!', 'success');
            
            // Valida√ß√£o de entrada em tempo real para n√∫mero
            document.getElementById('test-number').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 13) value = value.slice(0, 13);
                e.target.value = value;
                
                // Feedback visual
                if (value.length === 13) {
                    e.target.style.borderColor = 'var(--success)';
                } else if (value.length > 0) {
                    e.target.style.borderColor = 'var(--warning)';
                } else {
                    e.target.style.borderColor = 'var(--gray-200)';
                }
            });
            
            // Valida√ß√£o para nome da inst√¢ncia
            document.getElementById('instance-name').addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/[^a-zA-Z0-9-_]/g, '');
            });
            
            // Auto-carregar inst√¢ncias ap√≥s 3 segundos
            setTimeout(() => {
                loadInstances();
            }, 3000);
        });

        // ===== CLEANUP =====
        window.addEventListener('beforeunload', function() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                addLog('üîö Auto-refresh finalizado', 'info');
            }
        });

        // ===== DEBUG - Expor fun√ß√µes globalmente =====
        window.WppConnectManager = {
            refreshStatus,
            loadInstances,
            createInstance,
            generateQR,
            checkSessionStatus,
            sendTestMessage,
            API_BASE,
            SECRET_KEY
        };
    </script>
</body>
</html>
